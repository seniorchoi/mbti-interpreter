{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">MBTI Vision</h1>
    <form id="upload-form" method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <div class="form-group">
            <div id="drop-area" class="border border-secondary rounded p-3 text-center">
                <p>Upload your 3x3 MBTI image here.</p>
                {{ form.image(class="form-control-file d-none", id="image-input") }}
                <img id="preview-image" src="{% if encoded_image %}data:image/{{ file_ext.lower().strip('.') }};base64,{{ encoded_image }}{% elif filename %}{{ url_for('uploaded_file', filename=filename) }}{% endif %}" alt="Uploaded Image" class="img-fluid mb-3 {% if not encoded_image and not filename %}d-none{% endif %}">
            </div>
        </div>
        <div class="text-center">
            <button type="submit" class="btn btn-primary">Analyze Image</button>
            
        </div>
        <div class="text-center">
            <span id="loading-message" class="loading-message ml-2" style="display: none;">
                <span class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></span>
                Thinking...
            </span>
        </div>
    </form>
    {% if interpretation %}
    <div class="mt-5">
        <h3>Result:</h3>
        <p>{{ interpretation | markdown }}</p>
    </div>
    {% endif %}

    <div class="text-center">
        <small>vision uses 2 insights per submission.</small>
    </div>
    <div class="visitor-count text-right">
        <p>Visitors: {{ visitor_count }} | Visions: {{ vision_clicks }}</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var dropArea = document.getElementById('drop-area');
        var imageInput = document.getElementById('image-input');
        var previewImage = document.getElementById('preview-image');
    
        // Prevent default behaviors
        ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function(eventName) {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
    
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
    
        // Highlight drop area when item is dragged over it
        ;['dragenter', 'dragover'].forEach(function(eventName) {
            dropArea.addEventListener(eventName, function() {
                dropArea.classList.add('dragover');
            }, false);
        });
    
        ;['dragleave', 'drop'].forEach(function(eventName) {
            dropArea.addEventListener(eventName, function() {
                dropArea.classList.remove('dragover');
            }, false);
        });
    
        // Handle dropped files
        dropArea.addEventListener('drop', handleDrop, false);
    
        function handleDrop(e) {
            var dt = e.dataTransfer;
            var files = dt.files;
    
            if (files.length) {
                imageInput.files = files;
                previewFile(files[0]);
            }
        }
    
        // Trigger file input when drop area is clicked
        dropArea.addEventListener('click', function() {
            imageInput.click();
        }, false);
    
        // Handle file selection via file input
        imageInput.addEventListener('change', function() {
            if (imageInput.files.length) {
                previewFile(imageInput.files[0]);
            }
        });
    
        function previewFile(file) {
            var reader = new FileReader();
            reader.readAsDataURL(file);
    
            reader.onloadend = function() {
                previewImage.src = reader.result;
                previewImage.classList.remove('d-none');
            }
        }
    });
    </script>
    <!-- Loading Indicator Script -->
    <script>
        const form = document.getElementById('upload-form');
        const loadingMessage = document.getElementById('loading-message');

        form.addEventListener('submit', function() {
            loadingMessage.style.display = 'inline-block';
        });
        console.log('Unique Visitors: {{ unique_visitor_count }}');
    </script>
{% endblock %}