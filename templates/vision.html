{% extends "base.html" %}

{% block content %}
<div class="container mt-2">
    <h1 class="text-center">MBTI Image Guesser</h1>
    <form id="upload-form" method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <div class="form-group">
            <div id="drop-area" class="border border-secondary rounded p-3 text-center">
                <small>Upload image.</small>
                {{ form.image(class="form-control-file d-none", id="image-input") }}
                <img id="preview-image" src="{% if encoded_image %}{{ encoded_image }}{% endif %}" alt="Uploaded Image" class="img-fluid mb-3 {% if not encoded_image %}d-none{% endif %}">
            </div>
        </div>
        <div class="text-center">
            <button type="submit" class="btn btn-primary">Analyze Image</button>
            
        </div>
        <div class="text-center">
            <span id="loading-message" class="loading-message ml-2" style="display: none;">
                <span class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></span>
                Thinking...
            </span>
        </div>
    </form>
    <div id="result-section" class="mt-5 {% if not interpretation %}d-none{% endif %}">
        <h3>Result:</h3>
        <p id="interpretation-text">{% if interpretation %}{{ interpretation }}{% endif %}</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var dropArea = document.getElementById('drop-area');
        var imageInput = document.getElementById('image-input');
        var previewImage = document.getElementById('preview-image');
        var form = document.getElementById('upload-form');
        var loadingMessage = document.getElementById('loading-message');
        var resultSection = document.getElementById('result-section');
        var interpretationText = document.getElementById('interpretation-text');
    
        // Prevent default behaviors
        ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function(eventName) {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
    
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
    
        // Highlight drop area when item is dragged over it
        ;['dragenter', 'dragover'].forEach(function(eventName) {
            dropArea.addEventListener(eventName, function() {
                dropArea.classList.add('dragover');
            }, false);
        });
    
        ;['dragleave', 'drop'].forEach(function(eventName) {
            dropArea.addEventListener(eventName, function() {
                dropArea.classList.remove('dragover');
            }, false);
        });
    
        // Handle dropped files
        dropArea.addEventListener('drop', handleDrop, false);
    
        function handleDrop(e) {
            var dt = e.dataTransfer;
            var files = dt.files;
    
            if (files.length) {
                imageInput.files = files;
                previewFile(files[0]);
            }
        }
    
        // Trigger file input when drop area is clicked
        dropArea.addEventListener('click', function() {
            imageInput.click();
        }, false);
    
        // Handle file selection via file input
        imageInput.addEventListener('change', function() {
            if (imageInput.files.length) {
                previewFile(imageInput.files[0]);
            }
        });
    
        function previewFile(file) {
            var reader = new FileReader();
            reader.readAsDataURL(file);
    
            reader.onloadend = function() {
                previewImage.src = reader.result;
                previewImage.classList.remove('d-none');
            }
        }

        // Handle form submission via AJAX
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission
            loadingMessage.style.display = 'inline-block';

            var formData = new FormData(form);

            fetch('{{ url_for("vision") }}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                loadingMessage.style.display = 'none';
                if (data.error) {
                    alert(data.error);
                } else {
                    // Update the image preview
                    previewImage.src = data.encoded_image;
                    previewImage.classList.remove('d-none');

                    // Display the interpretation
                    interpretationText.innerHTML = data.interpretation;
                    resultSection.classList.remove('d-none');
                }
            })
            .catch(error => {
                loadingMessage.style.display = 'none';
                console.error('Error:', error);
                alert('An error occurred while processing your request.');
            });
        });
    });
    </script>
{% endblock %}